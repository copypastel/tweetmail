#!/usr/bin/env ruby -KU

# Frozen gems
%w:rubygems twitter:.each {|lib| require lib}

# Standard libraries
%w:optparse optparse/date optparse/time ostruct:.each {|lib| require lib}

# Local libs
%w:lib/twitter_ext lib/tweet_mail lib/helpers:.each {|lib| require lib}

# Option Parsing
#default options
options = {
  :config => File.join(File.dirname(__FILE__), "..","config","user-config.yaml")
  :server => File.join(File.dirname(__FILE__),'..','config','server-settings.yaml')
}

parser = OptionParser.new do |opts|
  opts.banner = "Usage: tweetmail [username] [email]"

  opts.separator ""
  opts.separator "Options:"

  opts.on("-s", "--since ID", "Email @reply tweets since a specified tweet id, e.g. --since 1378993302") do |s|
    options[:since] = s
  end
  
  opts.on("-c", "--config FILE", "Configuration file for twitter user, e.g. --config config/ecin.yaml") do |c|
    options[:config] = c
  end
  
  opts.on("-s", "--server FILE", "Configuration file for server, e.g. --server config/server-settings.yaml") do |s|
    options[:server] = s
  end
  
  opts.on("-w", "--write", "Write out configuration file after emailing the tweets.") do |n|
    if(n) then puts "File is saved as config/supplied_username.yaml."; end
    options[:write_config] = true
  end
  
  opts.on_tail("-h", "--help", "Show this message.") do
    puts opts
    exit
  end
end

parser.parse!

# Check cli arguments

if ARGV.length != 2 or (ARGV[1] =~ /\w+@\w+\.\w+/).nil? and options[:config].nil?
  puts parser
  exit
end

class App
  
  attr_accessor :arguments, :options
  alias :args :arguments
  
  def initialize(argv, options = {})
    @arguments = argv
    @options = options
  end
  
end

module TweetMail
  
  Twitter.extend TwitterExt
  
  attr_accessor :username, :email, :since
  
  def run
    #Set up SMTP settings
    server = TweetMail::Helpers::read_config(@options[:server])
    TweetMail::Helpers::set_mailer_smtp_settings(server)
    
    # Set attributes from command line arguments or config file
    if config = @options[:config]
      ostruct = TweetMail::Helpers::read_config(config)
      @username,@email,@since = [ ostruct.username, ostruct.email, ostruct.since ]
    else
      @username,@email,@since = [ args[0], args[1], options[:since] ]
    end
    
    # Get the @reply tweets
    @replies = Twitter::Replies(@username, @since)
    
    # Send out emails
    
    unless @replies.empty?
      TweetMail::send(@email, @replies) 
      @since = @replies.first.id
    end
    
    # Write a new configuration file for later use
    
    if @options[:write_config]
      TweetMail::Helpers::write_config(@username, @email, @since)
    end
    
    # Log what just happened
    
    File.open(File.join(File.dirname(__FILE__), '..','log','log.txt', 'a')) do |file|
      file << "Sent #{@replies.size} @replies to #{@email} at around #{Time.now.strftime("%H:%M%p %Z on %B %d, %Y")}.\n"
    end
    
  end
  
end

tm = App.new( ARGV, options )
tm.extend TweetMail
tm.run
